import BigNumber from 'bignumber.js'
import { stringUtils } from 'ptokens-helpers'
import Web3 from 'web3'
import { AbiItem } from 'web3-utils'

import * as utils from '../src/lib'

const abi = require('./utils/exampleContractABI.json')

const TEST_CONTRACT_ADDRESS = '0x15FA11dFB23eae46Fda69fB6A148f41677B4a090'
const TEST_ETH_PRIVATE_KEY = '422c874bed50b69add046296530dc580f8e2e253879d98d66023b7897ab15742'
const TEST_ETH_PROVIDER = 'https://goerli.infura.io/v3/4762c881ac0c4938be76386339358ed6'

describe('ethereum utilities', () => {
  test('Should return the correct Ethereum off-chain format', () => {
    const onChainAmount = new BigNumber(10000)
    const decimals = 4
    const expectedOffChainAmount = '1'
    const offChainAmount = utils.offChainFormat(onChainAmount, decimals).toFixed()
    expect(offChainAmount).toStrictEqual(expectedOffChainAmount)
  })

  test('Should return the correct Ethereum on-chain format', () => {
    const offChainAmount = new BigNumber(1)
    const decimals = 4
    const expectedOnChainAmount = '10000'
    const onChainAmount = utils.onChainFormat(offChainAmount, decimals).toFixed()
    expect(onChainAmount).toStrictEqual(expectedOnChainAmount)
  })

  test('Should return the current Ethereum account with non injected Web3 instance', async () => {
    const web3 = new Web3(TEST_ETH_PROVIDER)
    const expectedEthereumAccount = '0xdf3B180694aB22C577f7114D822D28b92cadFd75'
    const account = web3.eth.accounts.privateKeyToAccount(stringUtils.addHexPrefix(TEST_ETH_PRIVATE_KEY))
    web3.eth.defaultAccount = account.address
    const ethereumAccount = await utils.getAccount(web3)
    expect(ethereumAccount).toStrictEqual(expectedEthereumAccount)
  })

  test('Should return the current Ethereum account with injected Web3 instance', async () => {
    const web3 = new Web3(TEST_ETH_PROVIDER)
    const expectedEthereumAccount = '0xdf3B180694aB22C577f7114D822D28b92cadFd75'
    const getAccountsSpy = jest
      .spyOn(web3.eth, 'getAccounts')
      .mockImplementation(() => Promise.resolve([expectedEthereumAccount]))
    const ethereumAccount = await utils.getAccount(web3)
    expect(ethereumAccount).toStrictEqual(expectedEthereumAccount)
    expect(getAccountsSpy).toHaveBeenNthCalledWith(1)
  })

  test('Should return a valid Web3.eth.Contract instance', () => {
    const web3 = new Web3(TEST_ETH_PROVIDER)
    const contract = utils.getContract(web3, abi as unknown as AbiItem, TEST_CONTRACT_ADDRESS)
    const expectedContract = new web3.eth.Contract(abi as unknown as AbiItem, TEST_CONTRACT_ADDRESS)
    expect(JSON.stringify(contract)).toStrictEqual(JSON.stringify(expectedContract))
  })

  test('Should return a valid Web3.eth.Contract instance with default account', () => {
    const web3 = new Web3(TEST_ETH_PROVIDER)
    const account = web3.eth.accounts.privateKeyToAccount(stringUtils.addHexPrefix(TEST_ETH_PRIVATE_KEY))
    const contract = utils.getContract(web3, abi as unknown as AbiItem, TEST_CONTRACT_ADDRESS, account.address)
    const expectedContract = new web3.eth.Contract(abi as unknown as AbiItem, TEST_CONTRACT_ADDRESS)
    expectedContract.defaultAccount = account.address
    expect(JSON.stringify(contract)).toStrictEqual(JSON.stringify(expectedContract))
  })

  test('Should return a valid gas limit', async () => {
    const web3 = new Web3(TEST_ETH_PROVIDER)
    const getBlockSpy = jest.fn().mockResolvedValue({ gasLimit: 1000 })
    web3.eth.getBlock = getBlockSpy
    const gasLimit = await utils.getGasLimit(web3)
    expect(typeof gasLimit).toBe('number')
  })

  test('Should return true since 0xhello is 0x prefixed', () => {
    const string0xPrefixed = '0xhello'
    const result = stringUtils.isHexPrefixed(string0xPrefixed)
    expect(result).toBe(true)
  })

  test('Should return false since hello is not 0x prefixed', () => {
    const string0xNotPrefixed = 'hello0x'
    const result = stringUtils.isHexPrefixed(string0xNotPrefixed)
    expect(result).toBe(false)
  })

  // test('aaa', async () => {
  //   const web3 = new Web3('https://eth-sepolia.g.alchemy.com/v2/87AIPRGpZDJxfKM0dlZwZHcgWq9M6InD')
  //   const receipt = await web3.eth.getTransactionReceipt('0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2')
  //   //  {"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"logs":[{"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","address":"0xb7BF38fE4d06eD9330fbD6d5bea6C54bFD0Cd39f","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"data":"0x0000000000000000000000000000000000000000000000051f7371514a6a0000","logIndex":23,"removed":false,"topics":["0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925","0x000000000000000000000000ddb5f4535123daa5ae343c24006f4075abaf5f7b","0x000000000000000000000000ae2f9233c721670ed324ea499bf930fb166b63d0"],"transactionIndex":11,"id":"log_81cd897d"},{"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","address":"0xb7BF38fE4d06eD9330fbD6d5bea6C54bFD0Cd39f","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"data":"0x000000000000000000000000000000000000000000000000016345785d8a0000","logIndex":24,"removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000ddb5f4535123daa5ae343c24006f4075abaf5f7b","0x000000000000000000000000ae2f9233c721670ed324ea499bf930fb166b63d0"],"transactionIndex":11,"id":"log_3eecbe06"},{"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","address":"0xAE2f9233C721670ED324eA499BF930fB166B63D0","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"data":"0x000000000000000000000000000000000000000000000000016345785d8a0000","logIndex":25,"removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x0000000000000000000000000000000000000000000000000000000000000000","0x000000000000000000000000ddb5f4535123daa5ae343c24006f4075abaf5f7b"],"transactionIndex":11,"id":"log_86f22c35"},{"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","address":"0xAE2f9233C721670ED324eA499BF930fB166B63D0","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"data":"0x000000000000000000000000000000000000000000000000016345785d8a0000","logIndex":26,"removed":false,"topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000ddb5f4535123daa5ae343c24006f4075abaf5f7b","0x0000000000000000000000000000000000000000000000000000000000000000"],"transactionIndex":11,"id":"log_f28013e6"},{"transactionHash":"0xcd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd2","address":"0x009B71922e2d52CE013df4a380B29A33aF7B3894","blockHash":"0xca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23","blockNumber":3751503,"data":"0x000000000000000000000000000000000000000000000000000000000000d4b80000000000000000000000000000000000000000000000000000000000000180b92861540000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001e000000000000000000000000000000000000000000000000000000000000002200000000000000000000000000000000000000000000000000000000000000012000000000000000000000000b7bf38fe4d06ed9330fbd6d5bea6c54bfd0cd39fe15503e400000000000000000000000000000000000000000000000000000000000000000000000000000000b7bf38fe4d06ed9330fbd6d5bea6c54bfd0cd39f000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000002600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a307864446235663435333531323344416135614533343363323430303646343037356142414635463742000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003544b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","logIndex":27,"removed":false,"topics":["0xba98a314fb19bf102109515e22a4e48acbbe8f5610a657a9ed6cb3327afbc2e2"],"transactionIndex":11,"id":"log_2dd2c662"}],"contractAddress":null,"effectiveGasPrice":56524719073,"cumulativeGasUsed":6135725,"from":"0xddb5f4535123daa5ae343c24006f4075abaf5f7b","gasUsed":95615,"logsBloom":"0x00000200000000000000020000000000000000000000000000000000000000000000000000000000000000400080000000000020000000000000000000200000000000000000000000000008000000000002000000000000000000000000000000000000120000000000000000000800000000000000000000000010000000000000000000000002000000000000000000000000000010000004000000000000020000000000004000000000000000000000080000000000000000000000000000000002000000000000000020000000000000000000040000000200000020000010000000000000000000000000000000000000000000400000040010000000","status":true,"to":"0x009b71922e2d52ce013df4a380b29a33af7b3894","transactionIndex":11,"type":"0x2"}
  //   console.info(JSON.stringify(receipt))
  //   const a = utils.getOperationIdFromLog(receipt.logs[4], NetworkId.SepoliaTestnet)
  //   console.info(a)
  //   // 0xc6cc8381b3a70dc38c587d6c5518d72edb05b4040acbd4251fe6b67acff7f986
  // })

  // test('bbb', async () => {
  //   const web3 = new Web3('https://eth-goerli.g.alchemy.com/v2/e7XRoZjRoFecrVT06tHwApWd-CoBb6DD')
  //   const logs = await web3.eth.getPastLogs({
  //     address: '0xce22b9ba226b5d851d86c983656a9008fec25193',
  //     fromBlock: 9216150,
  //   })
  //   console.info(JSON.stringify(logs))
  //   // [{"address":"0xCE22B9ba226B5d851d86c983656a9008FeC25193","blockHash":"0x20868d15420f879faae4af717c42dfc3c1641015f47db11f9d46d67537f1af43","blockNumber":9227352,"data":"0x0000000000000000000000000000000000000000000000000000000000000020a12a3a320218d2a939f8bd21a665b7359bdaa7132870ab7422b44903aee3361f3c2930bdff5646aea313a8f6b5cb721469745982070b9209ebc1f468f419f5b70000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d4b80000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000b7bf38fe4d06ed9330fbd6d5bea6c54bfd0cd39fe15503e400000000000000000000000000000000000000000000000000000000b928615400000000000000000000000000000000000000000000000000000000e15503e40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000002a307864446235663435333531323344416135614533343363323430303646343037356142414635463742000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003544b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","logIndex":46,"removed":false,"topics":["0xd1a85d51ecfea5edd75f97fcf615b22c6f56eaf8f0487db9fadfbe661689b9af"],"transactionHash":"0x57d8d77b9267090663059b3fc33f1dd792123f4d9fc61362ff3ca1f0a134c5f3","transactionIndex":26,"id":"log_8d4876f2"},{"address":"0xCE22B9ba226B5d851d86c983656a9008FeC25193","blockHash":"0x855d7215e120340bd7749e091fba8e3a9a797323460ddb983725baf5bcf06a79","blockNumber":9227380,"data":"0x0000000000000000000000000000000000000000000000000000000000000020ca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23cd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d4b80000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000b7bf38fe4d06ed9330fbd6d5bea6c54bfd0cd39fe15503e400000000000000000000000000000000000000000000000000000000b928615400000000000000000000000000000000000000000000000000000000e15503e40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000002a307864446235663435333531323344416135614533343363323430303646343037356142414635463742000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003544b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","logIndex":73,"removed":false,"topics":["0xd1a85d51ecfea5edd75f97fcf615b22c6f56eaf8f0487db9fadfbe661689b9af"],"transactionHash":"0xe03f1eb68ca2c13c4b2d08abf4d6154c2846cb88a52333fd3c8128587ad0cd34","transactionIndex":36,"id":"log_7d9c12f5"},{"address":"0xCE22B9ba226B5d851d86c983656a9008FeC25193","blockHash":"0xa8a328ab107499eb430da386341e2b01af294047514747552eef3bb273ffa5c4","blockNumber":9227405,"data":"0x0000000000000000000000000000000000000000000000000000000000000020ca62d2a3c37a2f8e67ccb8635f8e72d2951ebdced604bc959dc9724c87171b23cd5f6d7d2aabd3af5269459b6310892f4e56aa0cfd05024ba16bcf901c9bccd20000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000d4b80000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000016345785d8a0000000000000000000000000000b7bf38fe4d06ed9330fbd6d5bea6c54bfd0cd39fe15503e400000000000000000000000000000000000000000000000000000000b928615400000000000000000000000000000000000000000000000000000000e15503e40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002a0000000000000000000000000000000000000000000000000000000000000002a307864446235663435333531323344416135614533343363323430303646343037356142414635463742000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005546f6b656e0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003544b4e00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","logIndex":185,"removed":false,"topics":["0xfb83c807750a326c5845536dc89b4d2da9f1f5e0df344e9f69f27c84f4d7d726"],"transactionHash":"0x88174f8b1c6715fee676c48d95d9ad6b126d008244c2ab3b28094a1e8267f547","transactionIndex":85,"id":"log_912d2e4d"}]
  // })
})
